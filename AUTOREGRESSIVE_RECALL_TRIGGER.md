# è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„è®°å¿†å›å¿†è§¦å‘æœºåˆ¶

## é—®é¢˜

å¦‚æœæ¨¡å‹åœ¨è‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­è‡ªå·±ç”Ÿæˆäº†`<recall>` tokenï¼Œèƒ½å¦è§¦å‘è®°å¿†å›å¿†æœºåˆ¶ï¼Ÿ

## ç­”æ¡ˆ

**âœ… å¯ä»¥ï¼** ä»£ç å·²ç»æ”¯æŒè¿™ä¸ªåŠŸèƒ½ã€‚

---

## è¯¦ç»†æµç¨‹åˆ†æ

### åœºæ™¯ï¼šæ¨¡å‹åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­è‡ªå·±è¾“å‡ºäº†`<recall>` token

å‡è®¾è¾“å…¥åºåˆ—ä¸ºï¼š`["æˆ‘", "éœ€", "è¦", "å›", "å¿†"]`ï¼Œæ¨¡å‹åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­è‡ªå·±è¾“å‡ºäº†`<recall>` tokenã€‚

#### **å¾ªç¯ç¬¬1è½®ï¼šå¤„ç†è¾“å…¥åºåˆ—**

1. **å‡†å¤‡æ¨¡å‹è¾“å…¥**
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†]`
   - `model_inputs = prepare_inputs_for_generation(input_ids, **model_kwargs)`
   - é¦–æ¬¡å¾ªç¯ï¼Œ`model_inputs['input_ids']` = å®Œæ•´è¾“å…¥åºåˆ—

2. **æ£€æµ‹<recall> token**
   - `current_input_ids = [æˆ‘, éœ€, è¦, å›, å¿†]`
   - `last_token_id = å¿†` token ID
   - âŒ ä¸æ˜¯`<recall>` tokenï¼Œä¸è§¦å‘

3. **å‰å‘ä¼ æ’­**
   - è¾“å…¥ï¼š`[æˆ‘, éœ€, è¦, å›, å¿†]`
   - ç”ŸæˆKV cacheï¼š5ä¸ªä½ç½®çš„KV

4. **é‡‡æ ·ä¸‹ä¸€ä¸ªtoken**
   - æ¨¡å‹è¾“å‡ºï¼šä¾‹å¦‚ "ä¸€"
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€]`

#### **å¾ªç¯ç¬¬2è½®ï¼šå¤„ç†æ–°token "ä¸€"**

1. **å‡†å¤‡æ¨¡å‹è¾“å…¥**
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€]`
   - ç”±äºä½¿ç”¨KV cacheï¼Œ`prepare_inputs_for_generation`ä¼šè£å‰ªï¼š
   - `model_inputs['input_ids'] = [ä¸€]`ï¼ˆåªä¼ å…¥æ–°tokenï¼‰

2. **æ£€æµ‹<recall> token**
   - `current_input_ids = [ä¸€]`
   - `last_token_id = ä¸€` token ID
   - âŒ ä¸æ˜¯`<recall>` tokenï¼Œä¸è§¦å‘

3. **å‰å‘ä¼ æ’­**
   - è¾“å…¥ï¼š`[ä¸€]`ï¼ˆå¤ç”¨ä¹‹å‰5ä¸ªä½ç½®çš„KV cacheï¼‰
   - ç”Ÿæˆæ–°tokençš„KV

4. **é‡‡æ ·ä¸‹ä¸€ä¸ªtoken**
   - æ¨¡å‹è¾“å‡ºï¼šä¾‹å¦‚ "ä¸‹"
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹]`

#### **å¾ªç¯ç¬¬3è½®ï¼šæ¨¡å‹è‡ªå·±ç”Ÿæˆ`<recall>` token**

1. **å‡†å¤‡æ¨¡å‹è¾“å…¥**
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹]`
   - `prepare_inputs_for_generation`è£å‰ªï¼š
   - `model_inputs['input_ids'] = [ä¸‹]`ï¼ˆåªä¼ å…¥æ–°tokenï¼‰

2. **æ£€æµ‹<recall> token**
   - `current_input_ids = [ä¸‹]`
   - `last_token_id = ä¸‹` token ID
   - âŒ ä¸æ˜¯`<recall>` tokenï¼Œä¸è§¦å‘

3. **å‰å‘ä¼ æ’­**
   - è¾“å…¥ï¼š`[ä¸‹]`ï¼ˆå¤ç”¨ä¹‹å‰6ä¸ªä½ç½®çš„KV cacheï¼‰

4. **é‡‡æ ·ä¸‹ä¸€ä¸ªtoken**
   - **å…³é”®**ï¼šæ¨¡å‹è‡ªå·±ç”Ÿæˆäº†`<recall>` token
   - `next_tokens = <recall>` token ID
   - `input_ids = torch.cat([input_ids, next_tokens[:, None]], dim=-1)`
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹, <recall>]`

#### **å¾ªç¯ç¬¬4è½®ï¼šæ£€æµ‹åˆ°æ¨¡å‹ç”Ÿæˆçš„`<recall>` tokenï¼Œè§¦å‘å›å¿†æœºåˆ¶**

1. **å‡†å¤‡æ¨¡å‹è¾“å…¥**
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹, <recall>]`
   - `prepare_inputs_for_generation`è£å‰ªï¼š
   - `model_inputs['input_ids'] = [<recall>]`ï¼ˆåªä¼ å…¥æ–°tokenï¼Œå› ä¸ºä¹‹å‰çš„tokenåœ¨KV cacheä¸­ï¼‰

2. **æ£€æµ‹<recall> token** â­
   - `current_input_ids = [<recall>]`
   - `last_token_id = <recall>` token ID
   - âœ… **æ£€æµ‹åˆ°æœ€åä¸€ä¸ªtokenæ˜¯`<recall>`ï¼**
   - âœ… è®¾ç½® `recall_pending = True`
   - `_log.info("ğŸ¯ [è¾“å…¥æ£€æµ‹] æ£€æµ‹åˆ°æœ€æ–°è¾“å…¥æ˜¯<recall> token (ID: {recall_token_id})ï¼Œè§¦å‘å›å¿†æœºåˆ¶")`

3. **å‰å‘ä¼ æ’­**
   - è¾“å…¥ï¼š`[<recall>]`ï¼ˆå¤ç”¨ä¹‹å‰7ä¸ªä½ç½®çš„KV cacheï¼‰
   - è¾“å‡ºï¼š`outputs.hidden_states[-1]` shape = `[batch_size, 1, hidden_size]`
   - æå–`<recall>` tokençš„hidden stateï¼š`last_hidden_state[0, -1, :]`

4. **å¤„ç†å›å¿†æœºåˆ¶** â­
   - âœ… æ£€æµ‹åˆ° `recall_pending = True`
   - æå–æŸ¥è¯¢å‘é‡ï¼š`query_vector = last_hidden_state[0, -1, :]`
   - æœç´¢è®°å¿†åº“ï¼š`memory_embedding, selected_meta = _sample_memory_embedding_from_db(query_vector)`
   - æ³¨å…¥è®°å¿†å‘é‡ï¼š`memory_outputs = _inject_memory_embedding(memory_embedding)`
   - æ›¿æ¢outputsï¼š`outputs = memory_outputs`
   - è®°å½•æ’å…¥ä½ç½®ï¼š`memory_injection_positions.append((8, 0.8438))`

5. **é‡‡æ ·ä¸‹ä¸€ä¸ªtoken**
   - `next_token_logits = outputs.logits[:, -1, :]`ï¼ˆè®°å¿†å‘é‡ä½ç½®çš„logitsï¼‰
   - åŸºäºè®°å¿†å‘é‡ç”Ÿæˆä¸‹ä¸€ä¸ªtokenï¼šä¾‹å¦‚ "ç”¨"
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹, <recall>, ç”¨]`

#### **å¾ªç¯ç¬¬5è½®ï¼šç»§ç»­ç”Ÿæˆ**

1. **å‡†å¤‡æ¨¡å‹è¾“å…¥**
   - `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹, <recall>, ç”¨]`
   - `model_inputs['input_ids'] = [ç”¨]`

2. **æ£€æµ‹<recall> token**
   - `current_input_ids = [ç”¨]`
   - âŒ ä¸æ˜¯`<recall>` tokenï¼Œä¸è§¦å‘

3. **ç»§ç»­æ­£å¸¸ç”Ÿæˆ...**

---

## å…³é”®æœºåˆ¶è¯´æ˜

### 1. `prepare_inputs_for_generation`çš„è£å‰ªè¡Œä¸º

åœ¨ä½¿ç”¨KV cacheçš„æƒ…å†µä¸‹ï¼Œ`prepare_inputs_for_generation`ä¼šï¼š
- å¦‚æœ`past_key_values`å­˜åœ¨ï¼Œåªä¼ å…¥`input_ids`ä¸­**æœªç¼“å­˜çš„token**
- é¦–æ¬¡å¾ªç¯ï¼šä¼ å…¥å®Œæ•´è¾“å…¥åºåˆ—
- åç»­å¾ªç¯ï¼šåªä¼ å…¥**æ–°ç”Ÿæˆçš„token**ï¼ˆå› ä¸ºä¹‹å‰çš„tokenå·²ç»åœ¨KV cacheä¸­ï¼‰

**ç¤ºä¾‹**ï¼š
- `input_ids = [æˆ‘, éœ€, è¦, å›, å¿†, ä¸€, ä¸‹, <recall>]`
- KV cacheåŒ…å«å‰7ä¸ªä½ç½®çš„KV
- `prepare_inputs_for_generation`åªä¼ å…¥`[<recall>]`ï¼ˆæ–°tokenï¼‰

### 2. æ£€æµ‹é€»è¾‘çš„ä½ç½®

æ£€æµ‹é€»è¾‘åœ¨**å‰å‘ä¼ æ’­ä¹‹å‰**ï¼ˆç¬¬2403-2418è¡Œï¼‰ï¼š
```python
# å‡†å¤‡æ¨¡å‹è¾“å…¥
model_inputs = model.prepare_inputs_for_generation(input_ids, **model_kwargs)

# æ£€æµ‹<recall> tokenï¼ˆåœ¨å‰å‘ä¼ æ’­ä¹‹å‰ï¼‰
current_input_ids = model_inputs.get('input_ids', input_ids)
if current_input_ids.shape[-1] > 0:
    last_token_id = current_input_ids[0, -1].item()
    if last_token_id == recall_token_id and not recall_pending:
        recall_pending = True

# å‰å‘ä¼ æ’­
outputs = model(**model_inputs, ...)
```

**å…³é”®ç‚¹**ï¼š
- æ£€æµ‹çš„æ˜¯`model_inputs['input_ids']`çš„æœ€åä¸€ä¸ªtoken
- åœ¨ä½¿ç”¨äº†KV cacheçš„æƒ…å†µä¸‹ï¼Œ`model_inputs['input_ids']`åªåŒ…å«æ–°ç”Ÿæˆçš„token
- å¦‚æœæ¨¡å‹ç”Ÿæˆäº†`<recall>` tokenï¼Œä¸‹ä¸€è½®å¾ªç¯æ—¶ä¼šè¢«æ£€æµ‹åˆ°

### 3. ä»£ç æ³¨é‡Šç¡®è®¤

ä»£ç ç¬¬2474-2476è¡Œæ˜ç¡®è¯´æ˜ï¼š
```python
# æ³¨æ„ï¼šè®°å¿†è§¦å‘æœºåˆ¶å·²ç»Ÿä¸€ä¸º"æ£€æµ‹åˆ°æœ€æ–°è¾“å…¥æ˜¯<recall> tokenæ—¶è§¦å‘"
# å› æ­¤ä¸å†éœ€è¦åœ¨è¿™é‡Œæ£€æµ‹ç”Ÿæˆçš„<recall> token
# ç”Ÿæˆçš„<recall> tokenä¼šåœ¨ä¸‹ä¸€è½®å¾ªç¯çš„å‰å‘ä¼ æ’­å‰è¢«æ£€æµ‹åˆ°
```

---

## å®Œæ•´ç¤ºä¾‹

### è¾“å…¥ï¼š`"æˆ‘éœ€è¦å›å¿†"`

**ç”Ÿæˆæµç¨‹**ï¼š

1. **å¾ªç¯1**ï¼šå¤„ç†è¾“å…¥`[æˆ‘, éœ€, è¦, å›, å¿†]` â†’ ç”Ÿæˆ "ä¸€"
2. **å¾ªç¯2**ï¼šå¤„ç† "ä¸€" â†’ ç”Ÿæˆ "ä¸‹"
3. **å¾ªç¯3**ï¼šå¤„ç† "ä¸‹" â†’ **æ¨¡å‹è‡ªå·±ç”Ÿæˆ`<recall>` token**
4. **å¾ªç¯4**ï¼šæ£€æµ‹åˆ°`<recall>` token â†’ è§¦å‘å›å¿†æœºåˆ¶
   - æå–`<recall>`çš„hidden state
   - æœç´¢è®°å¿†åº“ï¼Œæ‰¾åˆ°åŒ¹é…è®°å¿†ï¼ˆç›¸ä¼¼åº¦0.8438ï¼‰
   - æ³¨å…¥è®°å¿†å‘é‡
   - åŸºäºè®°å¿†å‘é‡ç”Ÿæˆ "ç”¨"
5. **å¾ªç¯5**ï¼šå¤„ç† "ç”¨" â†’ ç”Ÿæˆ "æˆ·"
6. **å¾ªç¯6**ï¼šå¤„ç† "æˆ·" â†’ ç”Ÿæˆ "çš„"
7. **...ç»§ç»­ç”Ÿæˆ...**

**æœ€ç»ˆè¾“å‡º**ï¼š
```
æˆ‘éœ€è¦å›å¿†ä¸€ä¸‹<recall>ç”¨æˆ·çš„ç”Ÿæ—¥æ˜¯1990å¹´1æœˆ1æ—¥...
```

**è®°å¿†æ’å…¥ä½ç½®è®°å½•**ï¼š
- ä½ç½®8ï¼šåœ¨æ¨¡å‹ç”Ÿæˆçš„`<recall>`ä¹‹åæ’å…¥äº†è®°å¿†å‘é‡ï¼ˆç›¸ä¼¼åº¦0.8438ï¼‰

---

## æ€»ç»“

### âœ… æ”¯æŒè‡ªå›å½’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„å›å¿†è§¦å‘

**è§¦å‘æ¡ä»¶**ï¼š
1. æ¨¡å‹åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­è‡ªå·±è¾“å‡ºäº†`<recall>` token
2. ä¸‹ä¸€è½®å¾ªç¯æ—¶ï¼Œ`prepare_inputs_for_generation`ä¼šå¤„ç†è¿™ä¸ªæ–°token
3. æ£€æµ‹é€»è¾‘ä¼šè¯†åˆ«`<recall>` tokenå¹¶è§¦å‘å›å¿†æœºåˆ¶

**å…³é”®ç‰¹ç‚¹**ï¼š
- âœ… æ— è®ºæ˜¯è¾“å…¥ä¸­çš„`<recall>`è¿˜æ˜¯æ¨¡å‹ç”Ÿæˆçš„`<recall>`ï¼Œéƒ½èƒ½è§¦å‘å›å¿†æœºåˆ¶
- âœ… ç»Ÿä¸€çš„è§¦å‘æœºåˆ¶ï¼šæ£€æµ‹åˆ°æœ€åä¸€ä¸ªè¾“å…¥tokenæ˜¯`<recall>`æ—¶è§¦å‘
- âœ… ä½¿ç”¨KV cacheæ—¶ï¼Œ`prepare_inputs_for_generation`ä¼šè‡ªåŠ¨è£å‰ªï¼Œåªä¼ å…¥æ–°token
- âœ… æ£€æµ‹é€»è¾‘åœ¨å‰å‘ä¼ æ’­ä¹‹å‰ï¼Œç¡®ä¿èƒ½åŠæ—¶è§¦å‘å›å¿†æœºåˆ¶

**ä»£ç ä½ç½®**ï¼š
- æ£€æµ‹é€»è¾‘ï¼šç¬¬2403-2418è¡Œ
- å›å¿†å¤„ç†ï¼šç¬¬2424-2452è¡Œ
- ä»£ç æ³¨é‡Šç¡®è®¤ï¼šç¬¬2474-2476è¡Œ

